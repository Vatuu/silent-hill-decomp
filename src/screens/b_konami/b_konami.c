#include "game.h"

#include <libcd.h>
#include <libetc.h>

#include "bodyprog/bodyprog.h"
#include "bodyprog/demo_system.h"
#include "bodyprog/save_system.h"
#include "main/fsqueue.h"
#include "screens/b_konami/b_konami.h"
#include "screens/stream/stream.h"

// TODO: Solve the issues related to the padding of the jump table generated by `func_800C99A4`.

s_800CA4F0 D_800CA4F0 =
{
    .field_0 = 0,
    .field_1 = 0x1F,
    .field_2 = 0xCE,
    .field_3 = 0xF3
};

u8* D_800CA4F4 = 0x801E2600;
s32 D_800CA4F8 = 0;
s32 D_800CA4FC = 0;
u8* D_800CA500 = 0;
u8* D_800CA504 = 0;
s32 D_800CA508 = 0;
u8* D_800CA50C = 0;
s32 D_800CA510 = 0;

void GameState_KonamiLogo_Update() // 0x800C95AC
{
    s32 idx;

    if (g_GameWork.gameState_594 != GameState_KonamiLogo)
    {
        return;
    }

    while (g_GameWork.gameState_594 == GameState_KonamiLogo)
    {
        Joy_Update();

        switch (g_GameWork.gameStateStep_598[0])
        {
            case 0:
                Gfx_Init(0x280, 1);

                g_Gfx_ScreenFade = 6;
                D_800B5C30       = 0x333;

                // Load \1ST\KONAMI2.TIM (Konami logo).
                Fs_QueueStartReadTim(FILE_1ST_KONAMI2_TIM, FS_BUFFER_1, &D_800A9004);
                
                func_8003D160();
                GameFs_BgItemLoad();
                func_8005E0DC(-1);

                // Start loading \ANIM\HB_BASE.ANM.
                Fs_QueueStartRead(FILE_ANIM_HB_BASE_ANM, FS_BUFFER_0);

                g_GameWork.gameStateStep_598[0]++;
                break;

            case 1:
                if (g_Gfx_ScreenFade == g_GameWork.gameStateStep_598[0])
                {
                    g_GameWork.gameStateStep_598[0] = 2;
                }
                break;

            case 2:
                if (g_ControllerPtrConst->btns_held_C != 0 || g_SysWork.timer_1C >= 181)
                {
                    g_Gfx_ScreenFade                = 3;
                    D_800B5C30                      = 0x333;
                    g_GameWork.gameStateStep_598[0] = 3;
                }
                break;

            case 3:
                if ((g_Gfx_ScreenFade & 7) == 5)
                {
                    Fs_QueueWaitForEmpty();
                    Game_StateSetNext(GameState_KcetLogo);
                }
                break;
        }

        Gfx_KonamiScreenDraw();
        func_8003260C();
        Fs_QueueUpdate();
        func_8002EB88();
        func_80033548();
        nullsub_800334C8();
        VSync(0);
        GsSwapDispBuff();
        GsDrawOt(&g_ObjectTable1[g_ObjectTableIdx]);

        idx = GsGetActiveBuff();
        g_ObjectTableIdx = idx;
        GsOUT_PACKET_P   = (PACKET*)(TEMP_MEMORY_ADDR + (idx << 15));

        GsClearOt(0, 0, &g_ObjectTable0[idx]);
        GsClearOt(0, 0, &g_ObjectTable1[g_ObjectTableIdx]);
    }
}

s32 func_800C9874() // 0x800C9874
{
    s32 saveEntryType0;
    s32 saveEntryType1;

    if (func_80033548() == 0)
    {
        return 1;
    }

    g_ActiveSavegameEntry = (s_SavegameEntry*)SAVEGAME_ENTRY_BUFFER_0;
    saveEntryType0        = g_ActiveSavegameEntry->type_4;

    g_ActiveSavegameEntry = (s_SavegameEntry*)SAVEGAME_ENTRY_BUFFER_1;
    saveEntryType1        = g_ActiveSavegameEntry->type_4;

    // No memory cards.
    if (saveEntryType0 == SavegameEntryType_NoMemCard && saveEntryType1 == SavegameEntryType_NoMemCard)
    {
        return 2;
    }

    if ((saveEntryType0 == SavegameEntryType_Unk4 && (saveEntryType1 == SavegameEntryType_Unk4 || saveEntryType1 == SavegameEntryType_NoMemCard)) ||
        (saveEntryType0 == SavegameEntryType_NoMemCard && saveEntryType1 == SavegameEntryType_Unk4)) 
    {
        return 3;
    }
    else if (saveEntryType0 == SavegameEntryType_Save || saveEntryType1 == SavegameEntryType_Save)
    {
        g_ActiveSavegameEntry = GetActiveSavegameEntry(g_SelectedSaveSlotIdx);
        g_ActiveSavegameEntry = &g_ActiveSavegameEntry[g_SlotElementSelectedIdx[g_SelectedSaveSlotIdx]];

        D_800BCD40        = g_ActiveSavegameEntry->field_5;
        g_SelectedFileIdx = g_ActiveSavegameEntry->fileIdx_6;
        g_SelectedSaveIdx = g_ActiveSavegameEntry->elementIdx_7;
        return 5;
    }
    
    return 4;
}

void GameState_KcetLogo_Update() // 0x800C99A4
{
    s_GameWork* ptr;

    while (g_GameWork.gameState_594 == GameState_KcetLogo)
    {
        Joy_Update();

        switch (g_GameWork.gameStateStep_598[0])
        {
            case 0:
                Settings_RestoreDefaults();

                g_Gfx_ScreenFade = 6;
                D_800B5C30       = 0x333;

                GameFs_BgEtcGfxLoad();
                Fs_QueueStartRead(FILE_BG_HP_SAFE1_BIN, FS_BUFFER_5);
                Fs_QueueStartRead(FILE_BG_S__SAFE2_BIN, FS_BUFFER_6);
                g_GameWork.gameStateStep_598[0]++;
                break;

            case 1:
                if (g_Gfx_ScreenFade == 1)
                {
                    Fs_QueueWaitForEmpty();
                    while (g_GameWork.gameStateStep_598[0] < 2)
                    {
                        g_GameWork.gameStateStep_598[0] = func_800C9874();
                        func_8002EB88();
                        VSync(0);
                    }
                }
                break;
                
            case 2:
                Fs_QueueStartReadTim(FILE_1ST_NO_MCD_E_TIM, FS_BUFFER_1, &D_800A900C);
                GameFs_StreamBinLoad();
                D_800CA4F0.field_0 = 3;

                g_GameWork.gameStateStep_598[0] = 6U;
                g_SysWork.timer_20 = 0;
                g_GameWork.gameStateStep_598[1] = 0;
                g_GameWork.gameStateStep_598[2] = 0;
                break;

            case 3:
                Fs_QueueStartReadTim(FILE_1ST_NO_BLK_E_TIM, FS_BUFFER_1, &D_800A900C);
                GameFs_StreamBinLoad();
                D_800CA4F0.field_0 = 3;

                g_GameWork.gameStateStep_598[0] = 6U;
                g_SysWork.timer_20 = 0;
                g_GameWork.gameStateStep_598[1] = 0;
                g_GameWork.gameStateStep_598[2] = 0;
                break;

            case 4:
                GameFs_StreamBinLoad();
                GameFs_TitleGfxSeek();
                D_800CA4F0.field_0 = 6;

                g_GameWork.gameStateStep_598[0] = 6U;
                g_SysWork.timer_20 = 0;
                g_GameWork.gameStateStep_598[1] = 0;
                g_GameWork.gameStateStep_598[2] = 0;
                break;

            case 5:
                if ((s32)g_GameWork.gameStateStep_598[1] < 3)
                {
                    ptr = g_GameWorkConst; 
                    do
                    {
                        switch ((s32)g_GameWork.gameStateStep_598[1])
                        {
                            case 0:
                                func_8002E94C(2, D_800BCD40, 0, 0);
                                g_GameWork.gameStateStep_598[2] = 0;
                                g_GameWork.gameStateStep_598[1]++;

                            case 1:
                                if (func_8002E990() != 1)
                                {
                                    g_GameWork.gameStateStep_598[2] = 0;
                                    g_GameWork.gameStateStep_598[1]++;
                                }
                                break;

                            case 2:
                                if ((s8)ptr->config_0.optAutoLoad_25 != 0)
                                {
                                    Fs_QueueStartRead(FILE_VIN_SAVELOAD_BIN, FS_BUFFER_1);
                                    Fs_QueueStartSeek(FILE_TIM_SAVELOAD_TIM);
                                    D_800CA4F0.field_0 = 4;
                                }
                                else 
                                {
                                    GameFs_StreamBinLoad();
                                    GameFs_TitleGfxSeek();
                                    D_800CA4F0.field_0 = 6;
                                }

                                g_GameWork.gameStateStep_598[2] = 0;
                                g_GameWork.gameStateStep_598[1]++;
                                break;
                        }

                        func_80033548();
                        func_8002EB88();
                        VSync(0);
                    }
                    while ((s32)g_GameWork.gameStateStep_598[1] < 3);
                }

                g_GameWork.gameStateStep_598[0] = 6U;
                g_SysWork.timer_20 = 0;
                g_GameWork.gameStateStep_598[1] = 0;
                g_GameWork.gameStateStep_598[2] = 0;
                break;

            case 6:
                if (g_ControllerPtrConst->btns_held_C != 0 || g_SysWork.timer_1C > 180)
                {
                    g_Gfx_ScreenFade = 3;
                    D_800B5C30       = 0x333;
                    g_GameWork.gameStateStep_598[0]++;
                }
                break;

            case 7:
                if ((g_Gfx_ScreenFade & 7) == 5)
                {
                    Settings_ScreenAndVolUpdate();
                    Gfx_Init(SCREEN_WIDTH, 0);

                    switch (D_800CA4F0.field_0)
                    {
                        case 4:
                            Fs_QueueStartReadTim(FILE_TIM_SAVELOAD_TIM, FS_BUFFER_7, &D_800A902C);
                            break;

                        case 3:
                            break;

                        case 5:
                        default:
                            GameFs_TitleGfxLoad();
                            break;
                    }

                    Demo_SequenceAdvance(0);
                    Demo_DemoDataRead();
                    Fs_QueueWaitForEmpty();

                    g_SysWork.timer_1C = 0;
                    g_SysWork.timer_20 = 0;

                    g_GameWork.gameStateStep_598[1] = 0;
                    g_GameWork.gameStateStep_598[2] = 0;

                    g_SysWork.sysState_8 = 0;
                    g_SysWork.timer_24 = 0;
                    g_SysWork.sysStateStep_C = 0;
                    g_SysWork.field_28 = 0;
                    g_SysWork.field_10 = 0;
                    g_SysWork.timer_2C = 0;
                    g_SysWork.field_14 = 0;

                    g_GameWork.gameStateStep_598[0] = g_GameWork.gameState_594;
                    g_GameWork.gameState_594 = D_800CA4F0.field_0;
                    g_GameWork.gameStatePrev_590 = g_GameWork.gameStateStep_598[0];
                    g_GameWork.gameStateStep_598[0] = 0U;
                }
                break;
        }
        
        Gfx_KcetScreenDraw();
        func_8003260C();
        Fs_QueueUpdate();
        func_8002EB88();
        func_80033548();
        nullsub_800334C8();
        VSync(0);
        GsSwapDispBuff();
        GsDrawOt(&g_ObjectTable1[g_ObjectTableIdx]);

        g_ObjectTableIdx = GsGetActiveBuff();
        GsOUT_PACKET_P = (g_ObjectTableIdx << 0xF) + (u32)TEMP_MEMORY_ADDR;

        GsClearOt(0, 0, &g_ObjectTable0[g_ObjectTableIdx]);
        GsClearOt(0, 0, &g_ObjectTable1[g_ObjectTableIdx]);
    }
}

void func_800C9E6C(s_FsImageDesc* image, s32 otz, s32 vramX, s32 vramY, s32 w, s32 h, s32 x, s32 y) // 0x800C9E6C
{
    DR_TPAGE* tPage;
    SPRT*     prim     = (SPRT*)GsOUT_PACKET_P;
    u32       vramBase = image->tPage[1] + (u32)(vramX >> 8) + (((u32)(vramY >> 8)) << 4);
    u32*      addr     = &D_800B5C40[g_ObjectTableIdx].field_0[otz];

    addPrimFast(addr, prim, 4);
    setCodeWord(prim, PRIM_RECT | RECT_TEXTURE, 0x808080);
    setWH(prim, w, h);

    vramX = vramX & 0xFF;
    vramY = vramY & 0xFF;

    //setUV0AndClut(prim, vramX, vramY, image->clutX, image->clutY);
    *(u32*)(&prim->u0) = vramX + (vramY << 8) + (((image->clutY << 6) | ((image->clutX >> 4) & 0x3F)) << 16);

    setXY0Fast(prim, (u16)x, y);

    tPage = (DR_TPAGE*)((u8*)prim + sizeof(SPRT));
    setDrawTPage(tPage, 0, 1, getTPage(image->tPage[0], 0, (vramBase << 6), (((vramBase >> 4) & (1 << 0)) << 8)));
    AddPrim(addr, tPage);

    GsOUT_PACKET_P = (u8*)prim + 28;
}

void Gfx_KonamiScreenDraw() // 0x800C9FB8
{
    s32* ptr;

    func_800C9E6C(&D_800A8FFC, 0xF, 0, 0, 256, 256, -192, -192);
    func_800C9E6C(&D_800A8FFC, 0xF, 256, 0, 128, 256, 64, -192);
    func_800C9E6C(&D_800A8FFC, 0xF, 0, 256, 256, 128, -192, 64);
    func_800C9E6C(&D_800A8FFC, 0xF, 256, 256, 128, 128, 64, 64);

    ptr = (g_ObjectTableIdx << 4) + &D_800B5C7C;

    addPrimFast(ptr, (TILE*)GsOUT_PACKET_P, 3);
    setCodeWord((TILE*)GsOUT_PACKET_P, PRIM_RECT, 0xFFFFFF);
    setXY0Fast((TILE*)GsOUT_PACKET_P, -SCREEN_WIDTH, -SCREEN_HEIGHT);
    setWH((TILE*)GsOUT_PACKET_P, SCREEN_WIDTH * 2, SCREEN_HEIGHT * 2);

    GsOUT_PACKET_P = (PACKET*)((u8*)GsOUT_PACKET_P + sizeof(TILE));
}

void Gfx_KcetScreenDraw() // 0x800CA120
{
    u32* ptr;

    func_800C9E6C(&D_800A9004, 0xF, 0, 0, 256, 160, -208, -80);
    func_800C9E6C(&D_800A9004, 0xF, 256, 0, 160, 160, 48, -80);

    ptr = (g_ObjectTableIdx << 4) + &D_800B5C7C;

    addPrimFast(ptr, (TILE*)GsOUT_PACKET_P, 3);
    setCodeWord((TILE*)GsOUT_PACKET_P, PRIM_RECT, 0xFFFFFF);
    setXY0Fast((TILE*)GsOUT_PACKET_P, -SCREEN_WIDTH, -SCREEN_HEIGHT);
    setWH((TILE*)GsOUT_PACKET_P, SCREEN_WIDTH * 2, SCREEN_HEIGHT * 2);

    GsOUT_PACKET_P = (PACKET*)((u8*)GsOUT_PACKET_P + sizeof(TILE));
}

void func_800CA234() // 0x800CA234
{
    D_800CA4FC = 0;
}

s32 func_800CA240(s32* arg0) // 0x800CA240
{
    return *arg0;
}

void func_800CA24C(s32 arg0, s32 arg1, s32 arg2) // 0x800CA24C
{
    s32 i;
    s32* ptr;

    D_800CA4FC = 1;
    D_800CA500 = arg0;
    D_800CA504 = arg1;
    D_800CA50C = arg0 + arg2;
    D_800CA500 = arg0 + 4;
    for (i = 0; i < 4096; i += 4)
    {
        ptr = D_800CA4F4 + i;
        *(s32*)ptr = 0;
    }

    D_800CA508 = 4078;
    D_800CA510 = 0;
}

s32 func_800CA2B8() // 0x800CA2B8
{
    return D_800CA4FC;
}

// NOTE: This is here to grab padding that should be generated by the jumptable,
// but which in this case is not being generated.
const s32 RodataPad = 0;

void func_800CA2C8(s32 arg0) // 0x800CA2C8
{
    static const s32 timeVar0 = 25;  // 0x19
    static const s32 timeVar1 = 180; // 0xB4

    s32 temp_v0;
    s32 currentTime;
    s32 temp_v1_2;

    s32 var_a1;

    s32 var_s1; // D_800CA508
    u32 var_s2; // D_800CA510
    s32 expectedTime;
    s32 var_v0;

    u32 temp_v0_2;
    u32 temp_v0_3;
    u32 temp_v1;
    
    u8* var_s0; // D_800CA500
    u8* temp_s5; // D_800CA50C
    u8* temp_a0;
    u8* temp_s0;
    u8* var_s3; // D_800CA504

    if (D_800CA4FC != 1)
    {
        return;
    }

    expectedTime = (arg0 * 263) - timeVar0;

    var_s0 = D_800CA500;
    var_s3 = D_800CA504;
    var_s1 = D_800CA508;
    var_s2 = D_800CA510;
    temp_s5 = D_800CA50C;

    currentTime = VSync(1);

    if (expectedTime - currentTime < timeVar1)
    {
        expectedTime = currentTime + 468;
        expectedTime = (expectedTime / 263) * 263;
        expectedTime -= timeVar0;
    }

    while (1)
    {
        if (var_s0 == temp_s5) 
        {
            D_800CA4FC = 0;
            break;
        }

        if ((var_s2 & (1 << 9)) == 0 && VSync(1) > expectedTime && arg0 != NO_VALUE)
        {
            break;
        }

        var_s2 = var_s2 / 2;
        var_v0 = var_s2;

        if ((var_s2 & (1 << 8)) == 0)
        {
            var_s2 = *var_s0;
            var_s0++;
            var_s2 = var_s2 | 0xFF00;
        }

        if ((var_s2 & 1) != 0)
        {
            temp_s0 = &D_800CA4F4[var_s1];
            temp_v1 = *var_s0;
            var_s0++;
            *temp_s0 = temp_v1;
            *var_s3 = temp_v1;
            var_s3++;
            var_s1++;
            var_s1 &= 0xFFF;
            continue;
        }

        if (var_s0 == (temp_s5 - 1))
        {
            D_800CA4FC = 0;
            break;
        }

        temp_v0 = *var_s0;
        var_s0++;

        temp_v0_2 = *var_s0 & 0xF0;
        temp_v0_3 = (*var_s0 & 0xF) + 3;
        temp_v0_2 = temp_v0_2 << 4;
        
        var_a1 = temp_v0 | temp_v0_2;
        temp_v1_2 = var_a1 + temp_v0_3;
        var_s0++;

        for (; var_a1 < (s16)temp_v1_2; var_a1++, var_s3++)
        {
            temp_v0_3 = D_800CA4F4[var_a1 & 0xFFF];
            
            D_800CA4F4[var_s1] = temp_v0_3;
            *var_s3 = temp_v0_3;

            var_s1++;
            var_s1 &= 0xFFF;
        }
    }

    D_800CA500 = var_s0;
    D_800CA504 = var_s3;
    D_800CA508 = var_s1;
    D_800CA50C = temp_s5;
    D_800CA510 = var_s2;
}
